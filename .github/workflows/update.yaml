name: Check for updates
on:
  schedule:
    - cron: '0 14 * * 1' # Run once a week, on Monday, at 14:00
  workflow_dispatch: {}

jobs:
  update-flatpak:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Get latest release tag
        id: latest
        run: |
          TAG=$(curl -s https://api.github.com/repos/AlexProgrammerDE/SoulFireClient/releases/latest | jq -r '.tag_name')
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

      - name: Download .debs
        run: |
          AMD64_URL="https://github.com/AlexProgrammerDE/SoulFireClient/releases/download/${RELEASE_TAG}/soulfire_${RELEASE_TAG}_amd64.deb"
          AARCH64_URL="https://github.com/AlexProgrammerDE/SoulFireClient/releases/download/${RELEASE_TAG}/soulfire_${RELEASE_TAG}_arm64.deb"
          wget "$AMD64_URL" -O soulfire_amd64.deb
          wget "$AARCH64_URL" -O soulfire_aarch64.deb
          echo "AMD64_URL=$AMD64_URL" >> $GITHUB_ENV
          echo "AARCH64_URL=$AARCH64_URL" >> $GITHUB_ENV

      - name: Calculate SHA256s
        id: hashes
        run: |
          SHA_AMD64=$(sha256sum soulfire_amd64.deb | cut -d ' ' -f1)
          SHA_AARCH64=$(sha256sum soulfire_aarch64.deb | cut -d ' ' -f1)
          echo "sha_amd64=$SHA_AMD64" >> $GITHUB_OUTPUT
          echo "sha_aarch64=$SHA_AARCH64" >> $GITHUB_OUTPUT

      - name: Update manifest
        run: |
          FILE="com.soulfiremc.soulfire.yaml"
          sed -i "s|url: .*amd64.deb|url: $AMD64_URL|" "$FILE"
          sed -i "s|sha256: .*|sha256: ${{ steps.hashes.outputs.sha_amd64 }}|" "$FILE"

          sed -i "s|url: .*arm64.deb|url: $AARCH64_URL|" "$FILE"
          sed -i "0,/sha256: .*/s//sha256: ${{ steps.hashes.outputs.sha_aarch64 }}/" "$FILE"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Update SoulFire Flatpak to ${{ env.RELEASE_TAG }}"
          branch: update/soulfire-${{ env.RELEASE_TAG }}
          title: "Update SoulFire to ${{ env.RELEASE_TAG }}"
          body: |
            This PR updates both amd64 and aarch64 `.deb` sources in the Flatpak manifest for version `${{ env.RELEASE_TAG }}`.
            Auto-generated by GitHub Actions.
          labels: auto-update
